

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>XID+ Example Run Script &mdash; XID+ 2.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="XID+ Example Output Analysis" href="XID+posterior_analysis_validation.html" />
    <link rel="prev" title="Tutorials" href="../../tutorial.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> XID+
          

          
          </a>

          
            
            
              <div class="version">
                2.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">A Generative Probabilistic Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html#docker">Docker</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../tutorial.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">XID+ Example Run Script</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#XID+-SPIRE">XID+ SPIRE</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="XID+posterior_analysis_validation.html">XID+ Example Output Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../hpc.html">Large Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../priors.html">Beyond Positional Priors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">XID+</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../tutorial.html">Tutorials</a> &raquo;</li>
        
      <li>XID+ Example Run Script</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/examples/XID+example_run_script.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="XID+-Example-Run-Script">
<h1>XID+ Example Run Script<a class="headerlink" href="#XID+-Example-Run-Script" title="Permalink to this headline">¶</a></h1>
<p>(This is based on a Jupyter notebook, available in the <a class="reference external" href="https://github.com/H-E-L-P/XID_plus/tree/master/docs/notebooks/examples/">XID+ package</a> and can be interactively run and edited)</p>
<p>XID+ is a probababilistic deblender for confusion dominated maps. It is designed to:</p>
<ol class="arabic simple">
<li>Use a MCMC based approach to get FULL posterior probability distribution on flux</li>
<li>Provide a natural framework to introduce additional prior information</li>
<li>Allows more representative estimation of source flux density uncertainties</li>
<li>Provides a platform for doing science with the maps (e.g XID+ Hierarchical stacking, Luminosity function from the map etc)</li>
</ol>
<p>Cross-identification tends to be done with catalogues, then science with the matched catalogues.</p>
<p>XID+ takes a different philosophy. Catalogues are a form of data compression. OK in some cases, not so much in others, i.e.&nbsp;confused images: catalogue compression loses correlation information. Ideally, science should be done without compression.</p>
<p>XID+ provides a framework to cross identify galaxies we know about in different maps, with the idea that it can be extended to do science with the maps!!</p>
<p>Philosophy:</p>
<ul class="simple">
<li>build a probabilistic generative model for the SPIRE maps</li>
<li>Infer model on SPIRE maps</li>
</ul>
<p>Bayes Theorem</p>
<p><span class="math notranslate nohighlight">\(p(\mathbf{f}|\mathbf{d}) \propto p(\mathbf{d}|\mathbf{f}) \times p(\mathbf{f})\)</span></p>
<p>In order to carry out Bayesian inference, we need a model to carry out inference on.</p>
<p>For the SPIRE maps, our model is quite simple, with likelihood defined as: <span class="math notranslate nohighlight">\(L = p(\mathbf{d}|\mathbf{f}) \propto |\mathbf{N_d}|^{-1/2} \exp\big\{ -\frac{1}{2}(\mathbf{d}-\mathbf{Af})^T\mathbf{N_d}^{-1}(\mathbf{d}-\mathbf{Af})\big\}\)</span></p>
<p>where: <span class="math notranslate nohighlight">\(\mathbf{N_{d,ii}} =\sigma_{inst.,ii}^2+\sigma_{conf.}^2\)</span></p>
<p>Simplest model for XID+ assumes following:</p>
<ul>
<li><p class="first">All sources are known and have positive flux (fi)</p>
</li>
<li><p class="first">A global background (B) contributes to all pixels</p>
</li>
<li><p class="first">PRF is fixed and known</p>
</li>
<li><p class="first rubric" id="confusion-noise-is-constant-and-not-correlated-across-pixels">Confusion noise is constant and not correlated across pixels</p>
<p>Because we are getting the joint probability distribution, our model is generative i.e.&nbsp;given parameters, we generate data and vica-versa</p>
</li>
</ul>
<p>Compared to discriminative model (i.e.&nbsp;neural network), which only obtains conditional probability distribution i.e.&nbsp;Neural network, give inputs, get output. Can’t go other way’</p>
<p>Generative model is full probabilistic model. Allows more complex relationships between observed and target variables</p>
<div class="section" id="XID+-SPIRE">
<h2>XID+ SPIRE<a class="headerlink" href="#XID+-SPIRE" title="Permalink to this headline">¶</a></h2>
<p>XID+ applied to GALFORM simulation of COSMOS field</p>
<ul class="simple">
<li>SAM simulation (with dust) ran through SMAP pipeline_ similar depth and size as COSMOS</li>
<li>Use galaxies with an observed 100 micron flux of gt. <span class="math notranslate nohighlight">\(50\mathbf{\mu Jy}\)</span>. Gives 64823 sources</li>
<li>Uninformative prior: uniform <span class="math notranslate nohighlight">\(0 - 10{^3} \mathbf{mJy}\)</span></li>
</ul>
<p>Import required modules</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">ascii</span><span class="p">,</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">wcs</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xidplus</span>
<span class="kn">from</span> <span class="nn">xidplus</span> <span class="k">import</span> <span class="n">moc_routines</span>
<span class="kn">import</span> <span class="nn">pickle</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/pdh21/anaconda3/envs/xidplus/lib/python3.6/site-packages/dask/config.py:168: YAMLLoadWarning: calling yaml.load() without Loader=... is deprecated, as the default Loader is unsafe. Please read https://msg.pyyaml.org/load for full details.
  data = yaml.load(f.read()) or {}
WARNING: AstropyDeprecationWarning: block_reduce was moved to the astropy.nddata.blocks module.  Please update your import statement. [astropy.nddata.utils]
</pre></div></div>
</div>
<p>Set image and catalogue filenames</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xidplus</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&#39;/Users/pdh21/Google_Drive/WORK/XID_plus/xidplus&#39;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Folder containing maps</span>
<span class="n">imfolder</span><span class="o">=</span><span class="n">xidplus</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/../test_files/&#39;</span>

<span class="n">pswfits</span><span class="o">=</span><span class="n">imfolder</span><span class="o">+</span><span class="s1">&#39;cosmos_itermap_lacey_07012015_simulated_observation_w_noise_PSW_hipe.fits.gz&#39;</span><span class="c1">#SPIRE 250 map</span>
<span class="n">pmwfits</span><span class="o">=</span><span class="n">imfolder</span><span class="o">+</span><span class="s1">&#39;cosmos_itermap_lacey_07012015_simulated_observation_w_noise_PMW_hipe.fits.gz&#39;</span><span class="c1">#SPIRE 350 map</span>
<span class="n">plwfits</span><span class="o">=</span><span class="n">imfolder</span><span class="o">+</span><span class="s1">&#39;cosmos_itermap_lacey_07012015_simulated_observation_w_noise_PLW_hipe.fits.gz&#39;</span><span class="c1">#SPIRE 500 map</span>


<span class="c1">#Folder containing prior input catalogue</span>
<span class="n">catfolder</span><span class="o">=</span><span class="n">xidplus</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/../test_files/&#39;</span>
<span class="c1">#prior catalogue</span>
<span class="n">prior_cat</span><span class="o">=</span><span class="s1">&#39;lacey_07012015_MillGas.ALLVOLS_cat_PSW_COSMOS_test.fits&#39;</span>


<span class="c1">#output folder</span>
<span class="n">output_folder</span><span class="o">=</span><span class="s1">&#39;./&#39;</span>
</pre></div>
</div>
</div>
<p>Load in images, noise maps, header info and WCS information</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#-----250-------------</span>
<span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pswfits</span><span class="p">)</span>
<span class="n">im250phdu</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">im250hdu</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

<span class="n">im250</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mf">1.0E3</span> <span class="c1">#convert to mJy</span>
<span class="n">nim250</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mf">1.0E3</span> <span class="c1">#convert to mJy</span>
<span class="n">w_250</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">pixsize250</span><span class="o">=</span><span class="mf">3600.0</span><span class="o">*</span><span class="n">w_250</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#pixel size (in arcseconds)</span>
<span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1">#-----350-------------</span>
<span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pmwfits</span><span class="p">)</span>
<span class="n">im350phdu</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">im350hdu</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

<span class="n">im350</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mf">1.0E3</span> <span class="c1">#convert to mJy</span>
<span class="n">nim350</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mf">1.0E3</span> <span class="c1">#convert to mJy</span>
<span class="n">w_350</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">pixsize350</span><span class="o">=</span><span class="mf">3600.0</span><span class="o">*</span><span class="n">w_350</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#pixel size (in arcseconds)</span>
<span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1">#-----500-------------</span>
<span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">plwfits</span><span class="p">)</span>
<span class="n">im500phdu</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">im500hdu</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">im500</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mf">1.0E3</span> <span class="c1">#convert to mJy</span>
<span class="n">nim500</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="mf">1.0E3</span> <span class="c1">#convert to mJy</span>
<span class="n">w_500</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">pixsize500</span><span class="o">=</span><span class="mf">3600.0</span><span class="o">*</span><span class="n">w_500</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#pixel size (in arcseconds)</span>
<span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Load in catalogue you want to fit (and make any cuts)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">catfolder</span><span class="o">+</span><span class="n">prior_cat</span><span class="p">)</span>
<span class="n">fcat</span><span class="o">=</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">inra</span><span class="o">=</span><span class="n">fcat</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span>
<span class="n">indec</span><span class="o">=</span><span class="n">fcat</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span>
<span class="c1"># select only sources with 100micron flux greater than 50 microJy</span>
<span class="n">sgood</span><span class="o">=</span><span class="n">fcat</span><span class="p">[</span><span class="s1">&#39;S100&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.050</span>
<span class="n">inra</span><span class="o">=</span><span class="n">inra</span><span class="p">[</span><span class="n">sgood</span><span class="p">]</span>
<span class="n">indec</span><span class="o">=</span><span class="n">indec</span><span class="p">[</span><span class="n">sgood</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>XID+ uses Multi Order Coverage (MOC) maps for cutting down maps and catalogues so they cover the same area. It can also take in MOCs as selection functions to carry out additional cuts. Lets use the python module <a class="reference external" href="http://pymoc.readthedocs.io/en/latest/">pymoc</a> to create a MOC, centered on a specific position we are interested in. We will use a HEALPix order of 15 (the resolution: higher order means higher resolution), have a radius of 100 arcseconds centered around an R.A. of 150.74 degrees
and Declination of 2.03 degrees.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="p">[</span><span class="mf">150.74</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="p">[</span><span class="mf">2.03</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pymoc</span>
<span class="n">moc</span><span class="o">=</span><span class="n">pymoc</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalog_to_moc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>XID+ is built around two python classes. A prior and posterior class. There should be a prior class for each map being fitted. It is initiated with a map, noise map, primary header and map header and can be set with a MOC. It also requires an input prior catalogue and point spread function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#---prior250--------</span>
<span class="n">prior250</span><span class="o">=</span><span class="n">xidplus</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="n">im250</span><span class="p">,</span><span class="n">nim250</span><span class="p">,</span><span class="n">im250phdu</span><span class="p">,</span><span class="n">im250hdu</span><span class="p">,</span> <span class="n">moc</span><span class="o">=</span><span class="n">moc</span><span class="p">)</span><span class="c1">#Initialise with map, uncertianty map, wcs info and primary header</span>
<span class="n">prior250</span><span class="o">.</span><span class="n">prior_cat</span><span class="p">(</span><span class="n">inra</span><span class="p">,</span><span class="n">indec</span><span class="p">,</span><span class="n">prior_cat</span><span class="p">)</span><span class="c1">#Set input catalogue</span>
<span class="n">prior250</span><span class="o">.</span><span class="n">prior_bkg</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="c1">#Set prior on background (assumes Gaussian pdf with mu and sigma)</span>
<span class="c1">#---prior350--------</span>
<span class="n">prior350</span><span class="o">=</span><span class="n">xidplus</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="n">im350</span><span class="p">,</span><span class="n">nim350</span><span class="p">,</span><span class="n">im350phdu</span><span class="p">,</span><span class="n">im350hdu</span><span class="p">,</span> <span class="n">moc</span><span class="o">=</span><span class="n">moc</span><span class="p">)</span>
<span class="n">prior350</span><span class="o">.</span><span class="n">prior_cat</span><span class="p">(</span><span class="n">inra</span><span class="p">,</span><span class="n">indec</span><span class="p">,</span><span class="n">prior_cat</span><span class="p">)</span>
<span class="n">prior350</span><span class="o">.</span><span class="n">prior_bkg</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

<span class="c1">#---prior500--------</span>
<span class="n">prior500</span><span class="o">=</span><span class="n">xidplus</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="n">im500</span><span class="p">,</span><span class="n">nim500</span><span class="p">,</span><span class="n">im500phdu</span><span class="p">,</span><span class="n">im500hdu</span><span class="p">,</span> <span class="n">moc</span><span class="o">=</span><span class="n">moc</span><span class="p">)</span>
<span class="n">prior500</span><span class="o">.</span><span class="n">prior_cat</span><span class="p">(</span><span class="n">inra</span><span class="p">,</span><span class="n">indec</span><span class="p">,</span><span class="n">prior_cat</span><span class="p">)</span>
<span class="n">prior500</span><span class="o">.</span><span class="n">prior_bkg</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Set PRF. For SPIRE, the PRF can be assumed to be Gaussian with a FWHM of 18.15, 25.15, 36.3 ’’ for 250, 350 and 500 <span class="math notranslate nohighlight">\(\mathrm{\mu m}\)</span> respectively. Lets use the astropy module to construct a Gaussian PRF and assign it to the three XID+ prior classes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#pixsize array (size of pixels in arcseconds)</span>
<span class="n">pixsize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pixsize250</span><span class="p">,</span><span class="n">pixsize350</span><span class="p">,</span><span class="n">pixsize500</span><span class="p">])</span>
<span class="c1">#point response function for the three bands</span>
<span class="n">prfsize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">18.15</span><span class="p">,</span><span class="mf">25.15</span><span class="p">,</span><span class="mf">36.3</span><span class="p">])</span>
<span class="c1">#use Gaussian2DKernel to create prf (requires stddev rather than fwhm hence pfwhm/2.355)</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="k">import</span> <span class="n">Gaussian2DKernel</span>

<span class="c1">##---------fit using Gaussian beam-----------------------</span>
<span class="n">prf250</span><span class="o">=</span><span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">prfsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.355</span><span class="p">,</span><span class="n">x_size</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span><span class="n">y_size</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
<span class="n">prf250</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;peak&#39;</span><span class="p">)</span>
<span class="n">prf350</span><span class="o">=</span><span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">prfsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.355</span><span class="p">,</span><span class="n">x_size</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span><span class="n">y_size</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
<span class="n">prf350</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;peak&#39;</span><span class="p">)</span>
<span class="n">prf500</span><span class="o">=</span><span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">prfsize</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">2.355</span><span class="p">,</span><span class="n">x_size</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span><span class="n">y_size</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
<span class="n">prf500</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;peak&#39;</span><span class="p">)</span>

<span class="n">pind250</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">pixsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#get 250 scale in terms of pixel scale of map</span>
<span class="n">pind350</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">pixsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#get 350 scale in terms of pixel scale of map</span>
<span class="n">pind500</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">pixsize</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#get 500 scale in terms of pixel scale of map</span>

<span class="n">prior250</span><span class="o">.</span><span class="n">set_prf</span><span class="p">(</span><span class="n">prf250</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="n">pind250</span><span class="p">,</span><span class="n">pind250</span><span class="p">)</span><span class="c1">#requires PRF as 2d grid, and x and y bins for grid (in pixel scale)</span>
<span class="n">prior350</span><span class="o">.</span><span class="n">set_prf</span><span class="p">(</span><span class="n">prf350</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="n">pind350</span><span class="p">,</span><span class="n">pind350</span><span class="p">)</span>
<span class="n">prior500</span><span class="o">.</span><span class="n">set_prf</span><span class="p">(</span><span class="n">prf500</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="n">pind500</span><span class="p">,</span><span class="n">pind500</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fitting &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prior250</span><span class="o">.</span><span class="n">nsrc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; sources </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;using &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">prior250</span><span class="o">.</span><span class="n">snpix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prior250</span><span class="o">.</span><span class="n">snpix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; and &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prior500</span><span class="o">.</span><span class="n">snpix</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; pixels&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
fitting 51 sources

using 870, 870 and 219 pixels
</pre></div></div>
</div>
<p>Before fitting, the prior classes need to take the PRF and calculate how much each source contributes to each pixel. This process provides what we call a pointing matrix. Lets calculate the pointing matrix for each prior class</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prior250</span><span class="o">.</span><span class="n">get_pointing_matrix</span><span class="p">()</span>
<span class="n">prior350</span><span class="o">.</span><span class="n">get_pointing_matrix</span><span class="p">()</span>
<span class="n">prior500</span><span class="o">.</span><span class="n">get_pointing_matrix</span><span class="p">()</span>

</pre></div>
</div>
</div>
<p>Default prior on flux is a uniform distribution, with a minimum and maximum of 0.00 and 1000.0 <span class="math notranslate nohighlight">\(\mathrm{mJy}\)</span> respectively for each source. running the function upper_lim _map resets the upper limit to the maximum flux value (plus a 5 sigma Background value) found in the map in which the source makes a contribution to.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prior250</span><span class="o">.</span><span class="n">upper_lim_map</span><span class="p">()</span>
<span class="n">prior350</span><span class="o">.</span><span class="n">upper_lim_map</span><span class="p">()</span>
<span class="n">prior500</span><span class="o">.</span><span class="n">upper_lim_map</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Now fit using the XID+ interface to pystan</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="kn">from</span> <span class="nn">xidplus.stan_fit</span> <span class="k">import</span> <span class="n">SPIRE</span>
<span class="n">fit</span><span class="o">=</span><span class="n">SPIRE</span><span class="o">.</span><span class="n">all_bands</span><span class="p">(</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">,</span><span class="nb">iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/XID+SPIRE found. Reusing
CPU times: user 106 ms, sys: 94 ms, total: 200 ms
Wall time: 1min 40s
</pre></div></div>
</div>
<p>Initialise the posterior class with the fit object from pystan, and save alongside the prior classes</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">posterior</span><span class="o">=</span><span class="n">xidplus</span><span class="o">.</span><span class="n">posterior_stan</span><span class="p">(</span><span class="n">fit</span><span class="p">,[</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">])</span>
<span class="n">xidplus</span><span class="o">.</span><span class="n">save</span><span class="p">([</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">],</span><span class="n">posterior</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Alternatively, you can fit with the <a class="reference external" href="http://pyro.ai/">pyro</a> backend.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="kn">from</span> <span class="nn">xidplus.pyro_fit</span> <span class="k">import</span> <span class="n">SPIRE</span>
<span class="n">fit_pyro</span><span class="o">=</span><span class="n">SPIRE</span><span class="o">.</span><span class="n">all_bands</span><span class="p">([</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">],</span><span class="n">n_steps</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span><span class="n">sub</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ELBO loss: 1260041.3781670125
ELBO loss: 1065185.5308887144
ELBO loss: 1130646.216561278
ELBO loss: 737672.9647120825
ELBO loss: 737046.7701195669
ELBO loss: 592995.6609225189
ELBO loss: 485981.24728407926
ELBO loss: 556506.0531864716
ELBO loss: 429984.75956812076
ELBO loss: 488600.43986501906
ELBO loss: 411460.8363188233
ELBO loss: 431718.87366976286
ELBO loss: 385351.7608406113
ELBO loss: 357830.9395776853
ELBO loss: 382459.2569340388
ELBO loss: 408383.5155558927
ELBO loss: 354037.0720273069
ELBO loss: 319367.88339216856
ELBO loss: 328824.352500674
ELBO loss: 344381.9609074172
ELBO loss: 332100.2516022554
ELBO loss: 329391.8185840579
ELBO loss: 343332.345573644
ELBO loss: 326011.7572739109
ELBO loss: 334392.6077349388
ELBO loss: 330918.6817200349
ELBO loss: 318738.5096039734
ELBO loss: 320144.5685866419
ELBO loss: 321469.1003236038
ELBO loss: 306684.0381109935
ELBO loss: 306222.3041109718
ELBO loss: 316213.57674243243
ELBO loss: 302028.4815525737
ELBO loss: 314143.9146362673
ELBO loss: 308849.6712405728
ELBO loss: 304463.31772266375
ELBO loss: 305575.8903153222
ELBO loss: 306456.8666223898
ELBO loss: 311497.9229997178
ELBO loss: 305731.40075046
ELBO loss: 294303.4184477164
ELBO loss: 307860.59128134267
ELBO loss: 302443.41479888145
ELBO loss: 302434.0722589671
ELBO loss: 296474.40906456474
ELBO loss: 294567.234372047
ELBO loss: 285571.05148711114
ELBO loss: 294979.9321089596
ELBO loss: 307534.403646474
ELBO loss: 292749.1740228964
ELBO loss: 285536.16612776933
ELBO loss: 287366.89226335345
ELBO loss: 293459.23931325413
ELBO loss: 280305.10191963566
ELBO loss: 277065.00076433073
ELBO loss: 289451.8705577
ELBO loss: 286710.267381722
ELBO loss: 282404.6378052321
ELBO loss: 281562.6099327593
ELBO loss: 295847.5997137869
ELBO loss: 273017.52899662626
ELBO loss: 274677.29919335956
ELBO loss: 276900.04703429725
ELBO loss: 284389.59261770954
ELBO loss: 281148.13386684057
ELBO loss: 271706.70894453634
ELBO loss: 270963.3115729156
ELBO loss: 269875.1825082948
ELBO loss: 272432.86866855825
ELBO loss: 279952.82368372695
ELBO loss: 272510.6373495866
ELBO loss: 267118.82284805377
ELBO loss: 273452.2512412447
ELBO loss: 269872.35647878784
ELBO loss: 272897.5109136318
ELBO loss: 268578.04057708185
ELBO loss: 276258.8245621037
ELBO loss: 274499.3222212271
ELBO loss: 274362.63846433384
ELBO loss: 283141.263292355
ELBO loss: 273089.84374107263
ELBO loss: 266347.15409340354
ELBO loss: 282845.53845229145
ELBO loss: 261515.5676478393
ELBO loss: 267451.12136338797
ELBO loss: 267560.7407516132
ELBO loss: 270542.2910159557
ELBO loss: 264882.88356716326
ELBO loss: 272371.00116332335
ELBO loss: 277567.8845486465
ELBO loss: 271701.2737767191
ELBO loss: 280858.06437200814
ELBO loss: 275251.6272502058
ELBO loss: 271682.6055318536
ELBO loss: 276401.524773806
ELBO loss: 266772.7698369609
ELBO loss: 264341.4297489914
ELBO loss: 267026.1641769626
ELBO loss: 275372.94887385744
ELBO loss: 287703.717028579
ELBO loss: 266513.15235830535
CPU times: user 7min 18s, sys: 9.28 s, total: 7min 27s
Wall time: 3min 12s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">posterior_pyro</span><span class="o">=</span><span class="n">xidplus</span><span class="o">.</span><span class="n">posterior_pyro</span><span class="p">(</span><span class="n">fit_pyro</span><span class="p">,[</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">])</span>
<span class="n">xidplus</span><span class="o">.</span><span class="n">save</span><span class="p">([</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">],</span><span class="n">posterior_pyro</span><span class="p">,</span><span class="s1">&#39;test_pyro&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">posterior_pyro</span><span class="o">.</span><span class="n">loss_history</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&lt;matplotlib.lines.Line2D at 0x7ff1559eda58&gt;]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_XID+example_run_script_33_1.png" src="../../_images/notebooks_examples_XID+example_run_script_33_1.png" />
</div>
</div>
<p>You can fit with the <a class="reference external" href="https://github.com/pyro-ppl/numpyro">numpyro</a> backend.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="kn">from</span> <span class="nn">xidplus.numpyro_fit</span> <span class="k">import</span> <span class="n">SPIRE</span>
<span class="n">fit_numpyro</span><span class="o">=</span><span class="n">SPIRE</span><span class="o">.</span><span class="n">all_bands</span><span class="p">([</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1min 10s, sys: 904 ms, total: 1min 10s
Wall time: 38.7 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">posterior_numpyro</span><span class="o">=</span><span class="n">xidplus</span><span class="o">.</span><span class="n">posterior_numpyro</span><span class="p">(</span><span class="n">fit_numpyro</span><span class="p">,[</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">])</span>
<span class="n">xidplus</span><span class="o">.</span><span class="n">save</span><span class="p">([</span><span class="n">prior250</span><span class="p">,</span><span class="n">prior350</span><span class="p">,</span><span class="n">prior500</span><span class="p">],</span><span class="n">posterior_numpyro</span><span class="p">,</span><span class="s1">&#39;test_numpyro&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of divergences: 0
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="XID+posterior_analysis_validation.html" class="btn btn-neutral float-right" title="XID+ Example Output Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../tutorial.html" class="btn btn-neutral" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Peter Hurley

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>