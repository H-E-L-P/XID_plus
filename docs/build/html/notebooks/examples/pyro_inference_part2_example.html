<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Part II - Pyro Inference &mdash; XID+ 3.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> XID+
          </a>
              <div class="version">
                3.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">A Generative Probabilistic Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html#docker">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hpc.html">Large Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../priors.html">Beyond Positional Priors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">XID+</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Part II - Pyro Inference</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/notebooks/examples/pyro_inference_part2_example.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Part-II---Pyro-Inference">
<h1>Part II - Pyro Inference<a class="headerlink" href="#Part-II---Pyro-Inference" title="Permalink to this headline">¶</a></h1>
<p>This is Part II of the time series tutorial <a class="reference external" href="https://pyro.ai/time">https://pyro.ai/time</a>. See also <a class="reference external" href="https://pyro.ai/time/part_i_models">Part I</a> and <a class="reference external" href="https://pyro.ai/time/part_iii_custom">Part III</a>.</p>
<p>We have already covered:</p>
<ul class="simple">
<li><p>Pyro primitives - <code class="docutils literal notranslate"><span class="pre">pyro.param</span></code>, <code class="docutils literal notranslate"><span class="pre">pyro.sample</span></code>.</p></li>
<li><p>Effect handlers - <code class="docutils literal notranslate"><span class="pre">poutine.replay</span></code>, <code class="docutils literal notranslate"><span class="pre">poutine.trace</span></code>.</p></li>
<li><p>Pyro models and guides.</p></li>
</ul>
<p>In this section, we will learn about <em>automatic inference</em> in Pyro, and how to use Pyro primitives and the effect handling library (<code class="docutils literal notranslate"><span class="pre">pyro.poutine</span></code>) to build custom tools for analysis.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">reset</span> -sf

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyro</span>
<span class="kn">import</span> <span class="nn">pyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">pyro.infer</span> <span class="kn">import</span> <span class="n">SVI</span><span class="p">,</span> <span class="n">Trace_ELBO</span>
<span class="kn">import</span> <span class="nn">pyro.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">pyro.poutine</span> <span class="k">as</span> <span class="nn">poutine</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">constraints</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;svg&#39;

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pyro ver: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pyro</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pytorch ver: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
pyro ver: 1.3.1
pytorch ver: 1.5.1
</pre></div></div>
</div>
<section id="Problem-Domain">
<h2>Problem Domain<a class="headerlink" href="#Problem-Domain" title="Permalink to this headline">¶</a></h2>
<p>We are provided with a time series dataset of the number of initial unemployment insurance claims for all of U.S. from the <a class="reference external" href="https://oui.doleta.gov/unemploy/claims.asp">Department of Labor</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unemployment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./unemployment_claims.csv&#39;</span><span class="p">)</span>
<span class="n">unemployment</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">unemployment</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
<span class="n">unemployment</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>initial claim</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-01-02</td>
      <td>651215</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-01-09</td>
      <td>825891</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-01-16</td>
      <td>659173</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-01-23</td>
      <td>507651</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-01-30</td>
      <td>538617</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">unemployment</span><span class="p">[</span><span class="s1">&#39;initial claim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;initial claim&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">unemployment</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Unemployment Insurance Claims&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_4_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_4_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_date</span> <span class="o">=</span> <span class="s1">&#39;2010-01-02&#39;</span>
<span class="n">time_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">init_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;7D&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="n">y_log</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="n">y_log</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Weekly Claims (Log Scale)&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;initial claim&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_5_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_5_0.svg" /></div>
</div>
</section>
<section id="Outline">
<h2>Outline<a class="headerlink" href="#Outline" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Build a <em>regression model</em> to model the global trend and seasonality - estimate parameters using ML.</p></li>
<li><p>Build a <em>bayesian model</em> for time series forecasting and infer latent parameters using:</p>
<ul>
<li><p>SVI (Autoguides)</p>
<ul>
<li><p>Delta Autoguide - MAP inference.</p></li>
<li><p>Diagonal Normal Autoguide.</p></li>
</ul>
</li>
<li><p>MCMC with a No-U-Turn Sampler (NUTS).</p></li>
</ul>
</li>
</ul>
</section>
<section id="Fitting-a-Regression-Model">
<h2>Fitting a Regression Model<a class="headerlink" href="#Fitting-a-Regression-Model" title="Permalink to this headline">¶</a></h2>
<section id="A-Global-Trend-Model">
<h3>A Global Trend Model<a class="headerlink" href="#A-Global-Trend-Model" title="Permalink to this headline">¶</a></h3>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
ln(y_i) &amp;\sim \mathcal{N}(\mu_i, \sigma)\\
\mu_i &amp;= slope\ .\ t_i + intercept \\
\end{align*}\end{split}\]</div>
<p>For simplicity, let us assume that <span class="math notranslate nohighlight">\(\sigma = 1\)</span> to begin with.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_global_trend</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">13.</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="n">log_y_hat</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">intercept</span>
        <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;y_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">log_y_hat</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pyro.param</span></code> designate model parameters that we would like to optimize.</p></li>
<li><p>Observations are denoted by the <code class="docutils literal notranslate"><span class="pre">obs=</span></code> keyword argument to <code class="docutils literal notranslate"><span class="pre">pyro.sample</span></code>. This specifies the likelihood function.</p></li>
<li><p>Instead of log transforming the data, we use a <em>LogNormal</em> distribution.</p></li>
</ul>
</section>
</section>
<section id="Vectorized-Model-Using-pyro.plate">
<h2>Vectorized Model Using <code class="docutils literal notranslate"><span class="pre">pyro.plate</span></code><a class="headerlink" href="#Vectorized-Model-Using-pyro.plate" title="Permalink to this headline">¶</a></h2>
<p>Tensor libraries like PyTorch have highly optimized linear algebra routines that can exploit data parallelism. Let us vectorize the <em>likelihood</em> computation to operate over all data in parallel.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_global_trend</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">13.</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">log_y_hat</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">intercept</span>
        <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">log_y_hat</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">?</span>pyro.plate
</pre></div>
</div>
</div>
</section>
<section id="Maximum-Likelihood-Estimate-of-the-Parameters">
<h2>Maximum Likelihood Estimate of the Parameters<a class="headerlink" href="#Maximum-Likelihood-Estimate-of-the-Parameters" title="Permalink to this headline">¶</a></h2>
<p><strong>Test-Train Split</strong>: Reserve the last 100 data-points for testing.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">N_test</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N_train</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="n">N_test</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="n">N_train</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">({</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">})</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">empty_guide</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span>
<span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model_global_trend</span><span class="p">,</span> <span class="n">empty_guide</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">Trace_ELBO</span><span class="p">())</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1600</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ELBO loss: 13.695740666221734
ELBO loss: 13.63005579656093
ELBO loss: 13.627845035725503
ELBO loss: 13.627821725816583
ELBO loss: 13.627820498979272
ELBO loss: 13.627818045304648
ELBO loss: 13.62781927214196
ELBO loss: 13.62781927214196
ELBO loss: 13.62781927214196
ELBO loss: 13.62781927214196
ELBO loss: 13.62781927214196
ELBO loss: 13.627818045304648
ELBO loss: 13.627818045304648
ELBO loss: 13.627818045304648
ELBO loss: 13.627818045304648
ELBO loss: 13.62781927214196
ELBO loss: 13.62781927214196
CPU times: user 2.08 s, sys: 76.2 ms, total: 2.15 s
Wall time: 2.97 s
</pre></div></div>
</div>
<ul class="simple">
<li><p>Important arguments to <code class="docutils literal notranslate"><span class="pre">SVI</span></code> - <em>model</em>, <em>guide</em>, <em>loss</em>.</p></li>
<li><p>We pass an empty guide <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">None</span></code> since the model does not have any latent parameters.</p></li>
<li><p>The loss function is given by <code class="docutils literal notranslate"><span class="pre">Trace_ELBO</span></code>. With an empty guide and only <code class="docutils literal notranslate"><span class="pre">pyro.param</span></code> statements in the model, this simply computes the NLL <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">log(p(y|x))</span></code>. We minimize this using the Adam optimizer.</p></li>
</ul>
<section id="Plotting-the-Regression-Fit">
<h3>Plotting the Regression Fit<a class="headerlink" href="#Plotting-the-Regression-Fit" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slope</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

<span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(tensor(-0.0018), tensor(13.0523))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train-test split&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Regression Fit&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;initial claim&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_20_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_20_0.svg" /></div>
</div>
</section>
</section>
<section id="Modeling-Seasonality">
<h2>Modeling Seasonality<a class="headerlink" href="#Modeling-Seasonality" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">52</span><span class="p">),</span> <span class="n">y</span><span class="p">[:</span><span class="mi">52</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;2010&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">52</span><span class="p">),</span> <span class="n">y</span><span class="p">[</span><span class="mi">52</span><span class="p">:</span><span class="mi">104</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;2011&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Weekly Claims (first 2 years)&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;initial claims&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_22_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_22_0.svg" /></div>
</div>
</section>
<section id="A-Sesonal-Global-Trend-(SGT)-Model">
<h2>A Sesonal Global Trend (SGT) Model<a class="headerlink" href="#A-Sesonal-Global-Trend-(SGT)-Model" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_sgt</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.</span><span class="p">))</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">13.</span><span class="p">))</span>
    <span class="n">seasonality</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;seasonality&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">52</span><span class="p">))</span>
    <span class="n">seasonality</span> <span class="o">=</span> <span class="n">seasonality</span> <span class="o">-</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">seasonality_factor</span> <span class="o">=</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="mi">52</span><span class="p">))[:</span><span class="n">N</span><span class="p">]</span>
        <span class="n">log_y_hat</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">seasonality_factor</span>
        <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">log_y_hat</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>In addition to the <em>global trend</em>, this includes a cyclic seasonality term. Note that this is a <em>multiplier</em> term.</p></li>
<li><p>We will use <code class="docutils literal notranslate"><span class="pre">SVI</span></code> to fit this model in a similar fashion.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">({</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">})</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">empty_guide</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span>
<span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model_sgt</span><span class="p">,</span> <span class="n">empty_guide</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">Trace_ELBO</span><span class="p">())</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3000</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ELBO loss: 26399.26381909548
ELBO loss: 13.683770414572864
ELBO loss: 13.631697304883794
ELBO loss: 13.61758131477701
ELBO loss: 13.615883371937814
ELBO loss: 13.615797493326005
ELBO loss: 13.615795039651381
CPU times: user 4.15 s, sys: 86.9 ms, total: 4.24 s
Wall time: 4.44 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
398
</pre></div></div>
</div>
<section id="id1">
<h3>Plotting the Regression Fit<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slope</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

<span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(tensor(-0.0018), tensor(13.0455))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slope</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="n">seasonality</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;seasonality&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="n">seasonality</span> <span class="o">=</span> <span class="p">(</span><span class="n">seasonality</span> <span class="o">-</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">seasonality_rep</span> <span class="o">=</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">52</span><span class="p">))[:</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
<span class="n">model_fit</span> <span class="o">=</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">seasonality_rep</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">,</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Seasonal + Global Trend Regression Model&#39;</span><span class="p">,</span>
          <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span>
          <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;initial claim&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train-test split&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">52</span><span class="p">),</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">exp</span><span class="p">())</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Seasonality Component&#39;</span><span class="p">,</span>
          <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;week of year&#39;</span><span class="p">,</span>
          <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;seasonality multiplier&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_30_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_30_0.svg" /></div>
</div>
</section>
</section>
<section id="A-Bayesian-Model-for-Forecasting">
<h2>A Bayesian Model for Forecasting<a class="headerlink" href="#A-Bayesian-Model-for-Forecasting" title="Permalink to this headline">¶</a></h2>
<p>We build on our previous <code class="docutils literal notranslate"><span class="pre">SGT</span></code> model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seasonality_mean</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;seasonality&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">N : Number of forecast steps from the current step.</span>
<span class="sd">x : Index for the last observed data from which to start forecasting.</span>
<span class="sd">y : Value for the last observed data.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">def</span> <span class="nf">prob_sgt</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">-</span><span class="mf">0.18</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1e-2</span>
    <span class="n">obs_sd</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;obs_sd&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="mf">1.</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="mi">52</span><span class="p">):</span>
        <span class="n">seasonality</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;seasonality&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">seasonality_mean</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
        <span class="n">seasonality</span> <span class="o">=</span> <span class="n">seasonality</span> <span class="o">-</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">seasonality_factor</span> <span class="o">=</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">52</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="mi">52</span><span class="p">))[:</span><span class="n">N</span><span class="p">]</span>
        <span class="n">y_intercept</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="o">-</span> <span class="n">seasonality</span><span class="p">[</span><span class="n">x</span> <span class="o">%</span> <span class="mi">52</span><span class="p">]</span>
        <span class="n">log_y_hat</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_intercept</span> <span class="o">+</span> <span class="n">seasonality_factor</span>
        <span class="k">return</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">log_y_hat</span><span class="p">,</span> <span class="n">obs_sd</span><span class="p">))</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>No <code class="docutils literal notranslate"><span class="pre">intercept</span></code> parameter, we instead take the current known value for <code class="docutils literal notranslate"><span class="pre">y</span></code> and forecast <code class="docutils literal notranslate"><span class="pre">N</span></code> steps ahead.</p></li>
<li><p>We need to account for which week we are in starting from the first week of Jan 2010 to apply the seasonality factor.</p></li>
<li><p>Priors for <code class="docutils literal notranslate"><span class="pre">slope</span></code>, <code class="docutils literal notranslate"><span class="pre">seasonality</span></code> and the observation noise <code class="docutils literal notranslate"><span class="pre">obs_sd</span></code>.</p></li>
<li><p>There is no <code class="docutils literal notranslate"><span class="pre">obs</span></code> argument. How are we going to train the model?</p></li>
</ul>
</section>
<section id="Are-the-Priors-Reasonable?">
<h2>Are the Priors Reasonable?<a class="headerlink" href="#Are-the-Priors-Reasonable?" title="Permalink to this headline">¶</a></h2>
<p>One way to check would be to generate samples from the model and check the overlap between distribution from the training set and the prior predictive distribution.</p>
<p>To generate samples from the prior, we will simply call the model multiple times and stack the predictions from the prior.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>

<span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">(</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
<span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span>
<span class="n">pred_p10</span><span class="p">,</span> <span class="n">pred_p50</span><span class="p">,</span> <span class="n">pred_p90</span> <span class="o">=</span> <span class="p">[</span><span class="n">preds</span><span class="o">.</span><span class="n">kthvalue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="o">*</span><span class="mi">500</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[:</span><span class="n">N_train</span><span class="p">],</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">N_train</span><span class="p">],</span> <span class="n">pred_p50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prior Predictive&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">N_train</span><span class="p">],</span> <span class="n">pred_p10</span><span class="p">,</span> <span class="n">pred_p90</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Before Training - Prior Predictive (90% CI)&#39;</span><span class="p">,</span>
       <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;initial claim&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2e6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_36_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_36_0.svg" /></div>
</div>
</section>
<section id="Inference-Using-Stochastic-Variational-Inference">
<h2>Inference Using Stochastic Variational Inference<a class="headerlink" href="#Inference-Using-Stochastic-Variational-Inference" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Provides a way to formulate the inference problem as an optimization problem.</p></li>
<li><p>Pyro provides state of the art support for VI.</p></li>
<li><p>Optimize the parameters of a <em>guide</em> program to generate samples from the approx posterior.</p></li>
</ul>
</section>
<section id="Autoguides">
<h2>Autoguides<a class="headerlink" href="#Autoguides" title="Permalink to this headline">¶</a></h2>
<p>We will use autoguides from the <a class="reference external" href="http://docs.pyro.ai/en/stable/infer.autoguide.html">pyro.infer.autoguide</a> module.</p>
<section id="MAP-Inference-Using-a-Delta-Autoguide">
<h3>MAP Inference Using a Delta Autoguide<a class="headerlink" href="#MAP-Inference-Using-a-Delta-Autoguide" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">from</span> <span class="nn">pyro.contrib.autoguide</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">({</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">})</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">1</span><span class="p">:]})</span>
<span class="n">guide_delta</span> <span class="o">=</span> <span class="n">AutoDelta</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">guide_delta</span><span class="p">(</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide_delta</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">Trace_ELBO</span><span class="p">())</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5000</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ELBO loss: 62.88858677933563
ELBO loss: 11.126496613175426
ELBO loss: 11.12649508472064
ELBO loss: 11.126495065251786
ELBO loss: 11.126495065251786
ELBO loss: 11.126495065251786
ELBO loss: 11.126495065251786
ELBO loss: 11.126495065251786
ELBO loss: 11.126513930121858
ELBO loss: 11.128522273433868
ELBO loss: 11.127055210534053
CPU times: user 16.8 s, sys: 254 ms, total: 17 s
Wall time: 17.7 s
</pre></div></div>
</div>
<p>Note the use of the <code class="docutils literal notranslate"><span class="pre">poutine.condition</span></code> handler to constrain the site <code class="docutils literal notranslate"><span class="pre">y</span></code> to our training set. The advantage of using <code class="docutils literal notranslate"><span class="pre">poutine.condition</span></code> is that we can use the same model for both training and forecasting!</p>
</section>
<section id="Examining-the-MAP-Parameters">
<h3>Examining the MAP Parameters<a class="headerlink" href="#Examining-the-MAP-Parameters" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pyro</span><span class="o">.</span><span class="n">get_param_store</span><span class="p">()</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;params&#39;: {&#39;AutoDelta.slope&#39;: Parameter containing:
  tensor(-0.1784, requires_grad=True),
  &#39;AutoDelta.obs_sd&#39;: Parameter containing:
  tensor(-0.4818, requires_grad=True),
  &#39;AutoDelta.seasonality&#39;: Parameter containing:
  tensor([ 0.3740,  0.5071,  0.4950,  0.2619,  0.1308,  0.1354,  0.0932,  0.0103,
          -0.0235,  0.0249, -0.0222, -0.0807, -0.0836, -0.0736,  0.0259,  0.0440,
          -0.0077, -0.0254, -0.0591, -0.0608, -0.0652, -0.0473, -0.0766,  0.0099,
           0.0175,  0.0219,  0.0547,  0.1484,  0.2195,  0.0159, -0.0981, -0.1067,
          -0.0841, -0.1222, -0.1301, -0.1290, -0.1848, -0.1527, -0.1658, -0.1799,
          -0.0381, -0.0027, -0.0423, -0.0174,  0.0287,  0.1000,  0.0624,  0.1120,
           0.1721,  0.2947,  0.1932,  0.2602], requires_grad=True)},
 &#39;constraints&#39;: {&#39;AutoDelta.slope&#39;: Real(),
  &#39;AutoDelta.obs_sd&#39;: GreaterThan(lower_bound=0.0),
  &#39;AutoDelta.seasonality&#39;: Real()}}
</pre></div></div>
</div>
</section>
</section>
<section id="Generating-Forecasts">
<h2>Generating Forecasts<a class="headerlink" href="#Generating-Forecasts" title="Permalink to this headline">¶</a></h2>
<section id="Replaying-from-a-Trained-Guide">
<h3>Replaying from a Trained Guide<a class="headerlink" href="#Replaying-from-a-Trained-Guide" title="Permalink to this headline">¶</a></h3>
<center><p><img alt="dc62cffc11b94cd2a37ce55af626795c" class="no-scaled-link" src="notebooks/examples/static/guide_program.png" style="width: 400px;" /></p>
</center><div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_predictive_samples</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                           <span class="n">guide</span><span class="p">,</span>
                           <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                           <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]):</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="n">guide_trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">guide</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">replay_model</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">replay</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide_trace</span><span class="p">)</span>
        <span class="n">model_trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">replay_model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;slope_sd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;obs_sd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;obs_sd&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
        <span class="n">preds</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">preds</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>Model remains the same for both inference and prediction.</p></li>
<li><p>To generate forecasts we can simply run the guide to sample latent values from the approximate posterior distribution, and replay these values in the model.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast_delta</span> <span class="o">=</span> <span class="n">get_predictive_samples</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">,</span> <span class="n">N_test</span><span class="p">,</span> <span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">guide</span><span class="o">=</span><span class="n">guide_delta</span><span class="p">)</span>
<span class="n">p10</span><span class="p">,</span> <span class="n">p50</span><span class="p">,</span> <span class="n">p90</span> <span class="o">=</span> <span class="p">[</span><span class="n">forecast_delta</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kthvalue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">:</span><span class="n">N_train</span><span class="o">+</span><span class="n">N_test</span><span class="p">],</span> <span class="n">p50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">398</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)],</span> <span class="n">p10</span><span class="p">,</span> <span class="n">p90</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Forecast (Delta Autoguide)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_48_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_48_0.svg" /></div>
</div>
</section>
<section id="Variational-Inference-Using-a-Normal-Autoguide">
<h3>Variational Inference Using a Normal Autoguide<a class="headerlink" href="#Variational-Inference-Using-a-Normal-Autoguide" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>The model and training procedure remains the same as earlier.</p></li>
<li><p>The Diagonal Normal Autoguide samples from a Normal distribution with diagonal covariance to generate samples from the approximate posterior distribution.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">ClippedAdam</span><span class="p">({</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">})</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">1</span><span class="p">:]})</span>
<span class="n">guide_diagnormal</span> <span class="o">=</span> <span class="n">AutoDiagonalNormal</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;auto_scale&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">54</span><span class="p">)</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">),</span> <span class="n">constraint</span><span class="o">=</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>

<span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide_diagnormal</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">Trace_ELBO</span><span class="p">())</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/distiller/project/conda/conda-bld/pytorch_1591914889657/work/torch/csrc/utils/python_arg_parser.cpp:756: UserWarning: This overload of add_ is deprecated:
        add_(Number alpha, Tensor other)
Consider using one of the following signatures instead:
        add_(Tensor other, *, Number alpha)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ELBO loss: 22.420856059163846
ELBO loss: 12.916967682203456
ELBO loss: 12.170049678889951
ELBO loss: 12.401121813920911
ELBO loss: 11.663290481172016
ELBO loss: 11.567352228802653
ELBO loss: 11.728647305288506
ELBO loss: 11.542766381897518
ELBO loss: 11.568688603951104
ELBO loss: 11.527311370899929
ELBO loss: 11.523166831863586
CPU times: user 41 s, sys: 550 ms, total: 41.6 s
Wall time: 43.2 s
</pre></div></div>
</div>
</section>
<section id="Plotting-the-Model’s-Forecast">
<h3>Plotting the Model’s Forecast<a class="headerlink" href="#Plotting-the-Model’s-Forecast" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guide_diagnormal</span><span class="o">.</span><span class="n">quantiles</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;slope&#39;: [tensor(-0.1802, grad_fn=&lt;ViewBackward&gt;),
  tensor(-0.1783, grad_fn=&lt;ViewBackward&gt;),
  tensor(-0.1764, grad_fn=&lt;ViewBackward&gt;)],
 &#39;obs_sd&#39;: [tensor(0.6376, grad_fn=&lt;AddBackward0&gt;),
  tensor(0.6669, grad_fn=&lt;AddBackward0&gt;),
  tensor(0.6975, grad_fn=&lt;AddBackward0&gt;)],
 &#39;seasonality&#39;: [tensor([ 0.3664,  0.4766,  0.4672,  0.2306,  0.0946,  0.1026,  0.0633, -0.0217,
          -0.0504, -0.0073, -0.0557, -0.1122, -0.1125, -0.1028, -0.0076,  0.0115,
          -0.0354, -0.0569, -0.0933, -0.0898, -0.0920, -0.0783, -0.1084, -0.0260,
          -0.0135, -0.0082,  0.0256,  0.1206,  0.1892, -0.0124, -0.1282, -0.1364,
          -0.1188, -0.1528, -0.1567, -0.1607, -0.2177, -0.1868, -0.1951, -0.2120,
          -0.0690, -0.0380, -0.0666, -0.0522, -0.0048,  0.0606,  0.0305,  0.0817,
           0.1467,  0.2637,  0.1638,  0.2353], grad_fn=&lt;ViewBackward&gt;),
  tensor([ 0.3708,  0.5058,  0.4973,  0.2595,  0.1244,  0.1326,  0.0932,  0.0076,
          -0.0210,  0.0211, -0.0270, -0.0835, -0.0828, -0.0733,  0.0218,  0.0411,
          -0.0069, -0.0280, -0.0643, -0.0599, -0.0635, -0.0485, -0.0785,  0.0038,
           0.0152,  0.0216,  0.0542,  0.1500,  0.2188,  0.0171, -0.0988, -0.1069,
          -0.0899, -0.1236, -0.1250, -0.1295, -0.1860, -0.1549, -0.1643, -0.1804,
          -0.0366, -0.0064, -0.0347, -0.0202,  0.0263,  0.0908,  0.0619,  0.1122,
           0.1788,  0.2950,  0.1955,  0.2668], grad_fn=&lt;ViewBackward&gt;),
  tensor([ 0.3751,  0.5349,  0.5273,  0.2884,  0.1542,  0.1625,  0.1231,  0.0369,
           0.0085,  0.0495,  0.0018, -0.0549, -0.0532, -0.0439,  0.0513,  0.0708,
           0.0217,  0.0009, -0.0353, -0.0301, -0.0350, -0.0187, -0.0487,  0.0336,
           0.0439,  0.0513,  0.0828,  0.1793,  0.2484,  0.0466, -0.0694, -0.0775,
          -0.0611, -0.0944, -0.0933, -0.0983, -0.1543, -0.1230, -0.1336, -0.1488,
          -0.0041,  0.0251, -0.0028,  0.0118,  0.0573,  0.1211,  0.0933,  0.1427,
           0.2110,  0.3262,  0.2272,  0.2982], grad_fn=&lt;ViewBackward&gt;)]}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast_diagnormal</span> <span class="o">=</span> <span class="n">get_predictive_samples</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">,</span> <span class="n">N_test</span><span class="p">,</span> <span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                             <span class="n">guide</span><span class="o">=</span><span class="n">guide_diagnormal</span><span class="p">)</span>
<span class="n">p10</span><span class="p">,</span> <span class="n">p50</span><span class="p">,</span> <span class="n">p90</span> <span class="o">=</span> <span class="p">[</span><span class="n">forecast_diagnormal</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kthvalue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">:</span><span class="n">N_train</span><span class="o">+</span><span class="n">N_test</span><span class="p">],</span> <span class="n">p50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">:</span><span class="n">N_train</span><span class="o">+</span><span class="n">N_test</span><span class="p">],</span> <span class="n">p10</span><span class="p">,</span> <span class="n">p90</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Forecast (Diagonal Normal Autoguide)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_53_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_53_0.svg" /></div>
</div>
</section>
</section>
<section id="Inference-Using-MCMC">
<h2>Inference Using MCMC<a class="headerlink" href="#Inference-Using-MCMC" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Pyro provides support for Hamiltonian Monte Carlo which is well suited to sample from high-dimensional continuous spaces.</p></li>
<li><p>In particular, we use the No-U-Turn algorithm for running HMC which adaptively sets many critical parameters for HMC.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyro.infer.mcmc</span> <span class="kn">import</span> <span class="n">NUTS</span>
<span class="kn">from</span> <span class="nn">pyro.infer.mcmc.api</span> <span class="kn">import</span> <span class="n">MCMC</span>
<span class="kn">from</span> <span class="nn">pyro.infer.mcmc.util</span> <span class="kn">import</span> <span class="n">predictive</span>
<span class="kn">from</span> <span class="nn">pyro.ops.stats</span> <span class="kn">import</span> <span class="n">hpdi</span>

<span class="kn">from</span> <span class="nn">torch.distributions.transforms</span> <span class="kn">import</span> <span class="n">AffineTransform</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">1</span><span class="p">:]})</span>
<span class="n">nuts_kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">jit_compile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_jit_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">nuts_kernel</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "5cc04695ac5d401389957db96c914dd0", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "05ab5a2dfd4c4784a4bcdaecf1db6b3a", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "96983f4985774208a78d5baebeabf890", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "808311672e9143b6acda479caafbf7ce", "version_major": 2, "version_minor": 0}</script></div>
</div>
<section id="Model-Summary">
<h3>Model Summary<a class="headerlink" href="#Model-Summary" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mcmc</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


                     mean       std    median      5.0%     95.0%     n_eff     r_hat
          slope     -0.18      0.00     -0.18     -0.18     -0.17   4190.57      1.00
         obs_sd      0.66      0.03      0.66      0.62      0.71   1640.48      1.00
 seasonality[0]      0.37      0.02      0.37      0.35      0.40    130.34      1.03
 seasonality[1]      0.51      0.03      0.51      0.46      0.55    296.55      1.02
 seasonality[2]      0.49      0.03      0.49      0.45      0.54    366.82      1.01
 seasonality[3]      0.26      0.03      0.26      0.22      0.30    404.48      1.01
 seasonality[4]      0.13      0.03      0.13      0.09      0.18    413.99      1.01
 seasonality[5]      0.14      0.03      0.14      0.09      0.18    445.08      1.01
 seasonality[6]      0.09      0.03      0.09      0.06      0.14    409.36      1.01
 seasonality[7]      0.01      0.03      0.01     -0.03      0.05    399.18      1.01
 seasonality[8]     -0.02      0.03     -0.02     -0.07      0.02    387.69      1.01
 seasonality[9]      0.02      0.03      0.03     -0.02      0.07    339.95      1.01
seasonality[10]     -0.02      0.03     -0.02     -0.06      0.02    363.41      1.01
seasonality[11]     -0.08      0.03     -0.08     -0.12     -0.04    345.68      1.02
seasonality[12]     -0.08      0.03     -0.08     -0.13     -0.04    342.02      1.01
seasonality[13]     -0.07      0.03     -0.07     -0.12     -0.03    363.95      1.01
seasonality[14]      0.03      0.03      0.03     -0.02      0.07    369.73      1.01
seasonality[15]      0.04      0.03      0.04     -0.00      0.09    352.19      1.01
seasonality[16]     -0.01      0.03     -0.01     -0.05      0.04    352.38      1.01
seasonality[17]     -0.03      0.03     -0.03     -0.07      0.02    318.25      1.01
seasonality[18]     -0.06      0.03     -0.06     -0.10     -0.02    347.87      1.01
seasonality[19]     -0.06      0.03     -0.06     -0.10     -0.02    374.32      1.01
seasonality[20]     -0.07      0.03     -0.06     -0.11     -0.03    401.81      1.01
seasonality[21]     -0.05      0.03     -0.05     -0.09     -0.00    381.88      1.01
seasonality[22]     -0.08      0.03     -0.08     -0.12     -0.03    352.64      1.01
seasonality[23]      0.01      0.03      0.01     -0.03      0.05    365.34      1.01
seasonality[24]      0.02      0.03      0.02     -0.03      0.06    378.86      1.01
seasonality[25]      0.02      0.03      0.02     -0.02      0.06    411.36      1.01
seasonality[26]      0.05      0.03      0.05      0.01      0.10    387.78      1.01
seasonality[27]      0.15      0.03      0.15      0.10      0.19    360.38      1.01
seasonality[28]      0.22      0.03      0.22      0.18      0.26    352.08      1.01
seasonality[29]      0.02      0.03      0.02     -0.03      0.06    374.96      1.01
seasonality[30]     -0.10      0.03     -0.10     -0.14     -0.05    423.33      1.01
seasonality[31]     -0.11      0.03     -0.11     -0.15     -0.06    311.62      1.02
seasonality[32]     -0.08      0.03     -0.08     -0.13     -0.04    331.68      1.01
seasonality[33]     -0.12      0.03     -0.12     -0.17     -0.08    381.49      1.01
seasonality[34]     -0.13      0.03     -0.13     -0.18     -0.08    418.21      1.01
seasonality[35]     -0.13      0.03     -0.13     -0.17     -0.08    352.13      1.01
seasonality[36]     -0.18      0.03     -0.19     -0.23     -0.14    404.80      1.01
seasonality[37]     -0.15      0.03     -0.15     -0.20     -0.11    367.51      1.01
seasonality[38]     -0.17      0.03     -0.17     -0.21     -0.12    424.00      1.01
seasonality[39]     -0.18      0.03     -0.18     -0.22     -0.13    335.00      1.01
seasonality[40]     -0.04      0.03     -0.04     -0.08      0.01    447.33      1.01
seasonality[41]     -0.00      0.03     -0.00     -0.05      0.04    443.58      1.01
seasonality[42]     -0.04      0.03     -0.04     -0.09      0.00    370.32      1.01
seasonality[43]     -0.02      0.03     -0.02     -0.06      0.03    429.21      1.01
seasonality[44]      0.03      0.03      0.03     -0.01      0.08    402.90      1.01
seasonality[45]      0.10      0.03      0.10      0.05      0.15    470.56      1.01
seasonality[46]      0.06      0.03      0.06      0.02      0.11    406.96      1.01
seasonality[47]      0.11      0.03      0.11      0.06      0.16    489.49      1.01
seasonality[48]      0.17      0.03      0.17      0.13      0.22    415.83      1.01
seasonality[49]      0.29      0.03      0.29      0.25      0.34    361.79      1.01
seasonality[50]      0.19      0.03      0.19      0.14      0.23    510.13      1.01
seasonality[51]      0.26      0.03      0.26      0.22      0.31    382.86      1.01


</pre></div></div>
</div>
</section>
<section id="Plotting-Model-Forecast">
<h3>Plotting Model Forecast<a class="headerlink" href="#Plotting-Model-Forecast" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyro.util</span> <span class="kn">import</span> <span class="n">ignore_experimental_warning</span>

<span class="k">with</span> <span class="n">ignore_experimental_warning</span><span class="p">():</span>
    <span class="n">forecast_mcmc</span> <span class="o">=</span> <span class="n">predictive</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">,</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">(),</span> <span class="n">N_test</span><span class="p">,</span> <span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">p10</span><span class="p">,</span> <span class="n">p90</span> <span class="o">=</span> <span class="n">hpdi</span><span class="p">(</span><span class="n">forecast_mcmc</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">p50</span> <span class="o">=</span> <span class="n">forecast_mcmc</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">:</span><span class="n">N_train</span><span class="o">+</span><span class="n">N_test</span><span class="p">],</span> <span class="n">p50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">:</span><span class="n">N_train</span><span class="o">+</span><span class="n">N_test</span><span class="p">],</span> <span class="n">p10</span><span class="p">,</span> <span class="n">p90</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Forecast (MCMC)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_60_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_60_0.svg" /></div>
</div>
</section>
<section id="Posterior-Distribution-of-Slope-for-MCMC-and-SVI">
<h3>Posterior Distribution of Slope for MCMC and SVI<a class="headerlink" href="#Posterior-Distribution-of-Slope-for-MCMC-and-SVI" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NUTS&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">forecast_diagnormal</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SVI (AutoDiagonalNormal)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior distribution of `slope`&#39;</span><span class="p">,</span>
       <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;slope&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_62_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_62_0.svg" /></div>
</div>
</section>
<section id="Variational-Inference-Using-a-Multivariate-Normal-Autoguide">
<h3>Variational Inference Using a Multivariate Normal Autoguide<a class="headerlink" href="#Variational-Inference-Using-a-Multivariate-Normal-Autoguide" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">ClippedAdam</span><span class="p">({</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">})</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">1</span><span class="p">:]})</span>
<span class="n">guide_mvn</span> <span class="o">=</span> <span class="n">AutoMultivariateNormal</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;auto_scale_tril&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag_embed</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">54</span><span class="p">,),</span> <span class="mf">1e-2</span><span class="p">)),</span>
           <span class="n">constraint</span><span class="o">=</span><span class="n">constraints</span><span class="o">.</span><span class="n">lower_cholesky</span><span class="p">)</span>

<span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide_mvn</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">Trace_ELBO</span><span class="p">())</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15000</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ELBO loss: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ELBO loss: 19.95344287678412
ELBO loss: 11.59777264162224
ELBO loss: 11.561684518453465
ELBO loss: 11.598039866766738
ELBO loss: 11.54362484648
ELBO loss: 11.557480851160221
ELBO loss: 11.579892492623785
ELBO loss: 11.53785526437975
ELBO loss: 11.523967811585072
ELBO loss: 11.548766153990924
ELBO loss: 11.583748653755714
ELBO loss: 11.55748783553665
ELBO loss: 11.552191911780055
ELBO loss: 11.581329234056737
ELBO loss: 11.551585462524663
ELBO loss: 11.554221333945216
CPU times: user 45.3 s, sys: 267 ms, total: 45.5 s
Wall time: 45.5 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecast_mvn</span> <span class="o">=</span> <span class="n">get_predictive_samples</span><span class="p">(</span><span class="n">prob_sgt</span><span class="p">,</span> <span class="n">N_test</span><span class="p">,</span> <span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">guide</span><span class="o">=</span><span class="n">guide_mvn</span><span class="p">)</span>
<span class="n">p10</span><span class="p">,</span> <span class="n">p50</span><span class="p">,</span> <span class="n">p90</span> <span class="o">=</span> <span class="p">[</span><span class="n">forecast_mvn</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">kthvalue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_train</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">:</span><span class="n">N_train</span><span class="o">+</span><span class="n">N_test</span><span class="p">],</span> <span class="n">p50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="n">N_train</span><span class="p">:</span><span class="n">N_train</span><span class="o">+</span><span class="n">N_test</span><span class="p">],</span> <span class="n">p10</span><span class="p">,</span> <span class="n">p90</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkorange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Forecast (AutoMultivariateNormal)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_65_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_65_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NUTS&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">forecast_mvn</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SVI (AutoMultivariateNormal)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior distribution of `slope`&#39;</span><span class="p">,</span>
       <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;slope&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_examples_pyro_inference_part2_example_66_0.svg" src="../../_images/notebooks_examples_pyro_inference_part2_example_66_0.svg" /></div>
</div>
</section>
</section>
<section id="Next-Steps">
<h2>Next Steps<a class="headerlink" href="#Next-Steps" title="Permalink to this headline">¶</a></h2>
<p>In <a class="reference external" href="https://pyro.ai/time/part_iii_custom">Part III</a> we will look into <strong>custom guides for scalable and flexible inference.</strong></p>
<p>To recap: - Modeling in Pyro is for the most part distinct from <em>inference</em>. - Pyro an array of black-box inference algorithms to use out of the box: - ML estimation using null guides. - SVI with autoguides - AutoDelta, AutoDiagNormal, AutoMultivariateNormal, flow-based guides, etc. - MCMC using NUTS sampler.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Peter Hurley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>